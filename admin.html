<!DOCTYPE html>
<html>
<head>
  <title>SikkMixx Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 30px;
    }

    input, button {
      padding: 10px;
      margin: 6px 0;
      width: 100%;
      max-width: 340px;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
      background: #222;
      color: white;
      border: 1px solid #444;
      border-radius: 6px;
    }

    button:hover { background: #333; }

    .hidden { display: none; }

    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      max-width: 800px;
    }

    .track {
      margin: 8px 0;
      padding: 10px 12px;
      background: #141414;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      max-width: 800px;
    }

    .meta {
      opacity: 0.8;
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.3;
    }

    .actions button {
      padding: 6px 10px;
      font-size: 12px;
      width: auto;
      margin: 0 0 0 8px;
    }

    .btn-danger {
      background: #3a0000;
      border-color: #6a0000;
    }
    .btn-danger:hover { background: #500000; }

    .btn-approve {
      background: #003a2a;
      border-color: #006a4a;
    }
    .btn-approve:hover { background: #005a40; }

    #status {
      margin-top: 10px;
      opacity: 0.85;
      font-size: 13px;
      max-width: 800px;
    }
  </style>
</head>

<body>
  <h1>üéõ SikkMixx Admin</h1>

  <div id="loginSection">
    <input id="username" placeholder="Username" autocomplete="username">
    <input id="password" type="password" placeholder="Password" autocomplete="current-password">
    <button id="loginBtn">Login</button>
    <div id="status"></div>
  </div>

  <div id="adminSection" class="hidden">
    <div class="row">
      <h2 id="welcomeText">Welcome</h2>
      <button id="logoutBtn" class="btn-danger">Logout</button>
    </div>

    <h2>Pending Submissions</h2>
    <div id="trackList"></div>
    <div id="status2"></div>
  </div>

<script>
const API = "https://api.sikkmixx.com";
let token = localStorage.getItem("token") || null;

     if (!token) window.location.href = "/login.html";

const loginSection = document.getElementById("loginSection");
const adminSection = document.getElementById("adminSection");
const statusDiv = document.getElementById("status");
const status2Div = document.getElementById("status2");

document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("logoutBtn").addEventListener("click", logout);

if (token) showAdmin();

function getUserFromToken(tok) {
  try {
    const payload = JSON.parse(atob(tok));
    return payload.username || "admin";
  } catch (e) {
    return "admin";
  }
}

function setStatus(msg, which = 1) {
  (which === 1 ? statusDiv : status2Div).textContent = msg;
}

async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  setStatus("Logging in...");

  const res = await fetch(`${API}/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  if (!res.ok) {
    setStatus("‚ùå Login failed");
    return;
  }

  const data = await res.json();
  token = data.token;
  localStorage.setItem("token", token);
  showAdmin();
}

function showAdmin() {
  loginSection.classList.add("hidden");
  adminSection.classList.remove("hidden");

  const username = getUserFromToken(token);
  document.getElementById("welcomeText").textContent = `üéõ Welcome, ${username}`;

  loadPending();
}

async function loadPending() {
  setStatus("Loading pending...", 2);

  const res = await fetch(`${API}/admin/pending`, {
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!res.ok) {
    setStatus("‚ùå Failed to load pending (are you admin?)", 2);
    return;
  }

  const tracks = await res.json();
  const list = document.getElementById("trackList");
  list.innerHTML = "";

  if (!tracks.length) {
    setStatus("No pending submissions üéâ", 2);
    return;
  }

  setStatus(`Pending: ${tracks.length}`, 2);

  tracks.forEach(track => {
    const div = document.createElement("div");
    div.className = "track";

    const name = track.original_name;
    const genre = track.genre ? `Genre: ${track.genre}` : "";
    const note = track.note ? `Note: ${track.note}` : "";

    div.innerHTML = `
      <div>
        <div><strong>${escapeHtml(name)}</strong></div>
        <div class="meta">${escapeHtml([genre, note].filter(Boolean).join(" ‚Ä¢ "))}</div>
      </div>
      <div class="actions">
        <button class="btn-approve" onclick="approveTrack(${track.id})">Approve</button>
        <button class="btn-danger" onclick="deleteTrack(${track.id})">Delete</button>
      </div>
    `;

    list.appendChild(div);
  });
}

async function approveTrack(id) {
  setStatus("Approving...", 2);

  const res = await fetch(`${API}/admin/approve`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({ id })
  });

  if (!res.ok) {
    const t = await res.text();
    setStatus("‚ùå Approve failed: " + t, 2);
    return;
  }

  await loadPending();
}

async function deleteTrack(id) {
  if (!confirm("Delete this submission?")) return;

  setStatus("Deleting...", 2);

  const res = await fetch(`${API}/admin/delete`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({ id })
  });

  if (!res.ok) {
    const t = await res.text();
    setStatus("‚ùå Delete failed: " + t, 2);
    return;
  }

  await loadPending();
}

function logout() {
  localStorage.removeItem("token");
  token = null;
  window.location.reload();
}

function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, s => ({
    "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
  }[s]));
}
</script>

</body>
</html>
